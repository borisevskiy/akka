## Почтовые ящики

### Вступление
В почтовом ящике Akka хранятся сообщения, предназначенные для актора. Обычно у каждого Актора есть свой собственный 
почтовый ящик, но, например, у `BalancingPool` все маршруты будут иметь общий экземпляр почтового ящика.

### Выбор почтового ящика
#### Требование типа очереди сообщений для актора
Можно запросить определенный тип очереди сообщений для определенного типа актора, если этот актор расширяет 
параметризованный признак RequiresMessageQueue. Вот пример:

```scala
import akka.dispatch.RequiresMessageQueue
import akka.dispatch.BoundedMessageQueueSemantics

class MyBoundedActor extends MyActor
  with RequiresMessageQueue[BoundedMessageQueueSemantics]
```

Параметр типа для атрибута `RequiresMessageQueue` должен быть сопоставлен с почтовым ящиком в конфигурации следующим образом:

```scala
bounded-mailbox {
  mailbox-type = "akka.dispatch.NonBlockingBoundedMailbox"
  mailbox-capacity = 1000 
}

akka.actor.mailbox.requirements {
  "akka.dispatch.BoundedMessageQueueSemantics" = bounded-mailbox
}
```

Теперь каждый раз, когда вы создаете актора типа `MyBoundedActor`, он попытается получить ограниченный почтовый ящик. 
Если у актора есть другой почтовый ящик, настроенный в развертывании, либо напрямую, либо через диспетчера с указанным 
типом почтового ящика, то это переопределит это сопоставление.

>Тип очереди в почтовом ящике, созданный для актора, будет проверен на требуемый тип в признаке, и если очередь не 
реализует требуемый тип, то создание актора завершится ошибкой.

#### Требование типа очереди сообщений для диспетчера
Диспетчер может также иметь требование для типа почтового ящика, используемого действующими на нем участниками. 
Например, `BalancingDispatcher`, который требует очереди сообщений, которая является потокобезопасной для нескольких 
одновременных потребителей. Такое требование сформулировано в разделе конфигурации диспетчера следующим образом:

```yaml
my-dispatcher {
  mailbox-requirement = org.example.MyInterface
}
```

Данное требование именует класс или интерфейс, которые затем будут гарантированы как супертип реализации очереди 
сообщений. В случае конфликта - например. если актору требуется тип почтового ящика, который не удовлетворяет этому 
требованию, то создание актора не удастся.

### Как выбран тип почтового ящика
Когда актор создается, `ActorRefProvider` сначала определяет диспетчера, который его выполнит. Затем почтовый ящик 
определяется следующим образом:

1. Если раздел конфигурации развертывания актора содержит ключ почтового ящика, он называет раздел конфигурации, 
описывающий тип почтового ящика, который будет использоваться.
2. Если Акты Актора содержат выбор почтового ящика - т.е. с ним был вызван метод `Mailbox`, затем он описывает раздел 
конфигурации, описывающий используемый тип почтового ящика (обратите внимание, что это должен быть абсолютный путь 
конфигурации, например `myapp.special-mailbox`, и не вложен в пространство имен akka).
3. Если раздел конфигурации диспетчера содержит ключ типа почтового ящика, тот же раздел будет использоваться для 
настройки типа почтового ящика.
4. Если актору требуется тип почтового ящика, как описано выше, сопоставление для этого требования будет использоваться
 для определения используемого типа почтового ящика; если это не удастся, вместо этого будет требоваться требование 
 диспетчера, если оно есть.
5. Если диспетчеру требуется тип почтового ящика, как описано выше, сопоставление для этого требования будет 
использоваться для определения используемого типа почтового ящика.
6. Будет использоваться почтовый ящик по умолчанию `akka.actor.default-mailbox`.

#### Почтовый ящик по умолчанию
Когда почтовый ящик не указан, как описано выше, используется почтовый ящик по умолчанию. По умолчанию это неограниченный
 почтовый ящик, который поддерживается `java.util.concurrent.ConcurrentLinkedQueue.`

`SingleConsumerOnlyUnboundedMailbox` - еще более эффективный почтовый ящик, и его можно использовать как почтовый ящик
 по умолчанию, но он не может использоваться с `BalancingDispatcher`.

Конфигурация `SingleConsumerOnlyUnboundedMailbox` в качестве почтового ящика по умолчанию:

```yaml
akka.actor.default-mailbox {
  mailbox-type = "akka.dispatch.SingleConsumerOnlyUnboundedMailbox"
}
```

#### Какая конфигурация передается в тип почтового ящика
Каждый тип почтового ящика реализуется классом, который расширяет `MailboxType` и принимает два аргумента конструктора:
 объект `ActorSystem.Settings` и раздел `Config`. Последний вычисляется путем получения именованного раздела конфигурации 
 из конфигурации системы актера, переопределяя его идентификационный ключ с помощью пути конфигурации типа почтового 
 ящика и добавляя спад в раздел конфигурации почтовых ящиков по умолчанию.
 
 [Подробнее](https://doc.akka.io/docs/akka/current/mailboxes.html)

_Если этот проект окажется полезным тебе - нажми на кнопочку **`★`** в правом верхнем углу._

[<= содержание](https://github.com/steklopod/akka/blob/akka_starter/readme.md)